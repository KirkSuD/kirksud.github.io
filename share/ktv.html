<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="utf-8">
    <title>KTV KKBOX</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">

    <meta name="description" content="KTV號碼查詢、KKBOX華語單曲週榜、音樂播放器">
    <meta property="og:title" content="KTV KKBOX">
    <meta property="og:description" content="KTV號碼查詢、KKBOX華語單曲週榜、音樂播放器">
    <meta property="og:url" content="https://kirksud.github.io/share/ktv.html">
    <meta name="twitter:card" content="summary">
    <meta property="og:site_name" content="kirksud.github.io">

    <link rel="icon" href="icon/icon.svg" sizes="any" type="image/svg+xml">
    <link rel="icon" href="icon/icon_512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="icon/icon_192.png" sizes="192x192" type="image/png">

    <link rel="manifest" href="manifest/ktv.json">

    <link rel="stylesheet" crossorigin="anonymous"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1">

    <style>

html {
    height: 100%;
}
body {
    margin: 0;
    height: 100%;
    justify-content: center;
    overflow-y: hidden; /* to disable chrome mobile pull-to-refresh */
}
p, pre {
    margin: 0;
}

#main {
    width: 100%;
    max-width: 576px;
    padding: 1vh 3vw 0;
}
#main > * {
    margin: 1vmin;
}
#items {
    overflow: auto;
}
#items > div:nth-child(2n+1) {
    background-color: rgb(240, 240, 240);
}
#items > div:first-child {
    border-top: 1px solid rgb(200, 200, 200);
}
#items > div {
    border-bottom: 1px solid rgb(200, 200, 200);
    padding: 1vh 1vw;
    cursor: pointer;
    user-select: none;
}
#items > div > div {
    margin: 1.5vh 0;
}
#title, #company, #search, #selectStart, #selectEnd {
    padding: 1vh 0.5vw;
}
#nav, #filterBar {
    align-items: center;
}
#filterBar label {
    user-select: none;
}
#detail > p {
    margin: 1vh 0;
}
#detail > hr {
    margin: 2vh 0;
}

.d-none {
    display: none;
}
.d-flex {
    display: flex;
}
.flex-column {
    flex-direction: column;
}
.flex-1 {
    flex: 1;
}
.font-small {
    font-size: small;
}
.font-large {
    font-size: large;
}
.font-bold {
    font-weight: bold;
}

.modal {
    position: fixed;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    padding: 3vmin;
    display: none;
}
.modal-open {
    display: flex;
    justify-content: center;
    align-items: center;
}
.backdrop {
    position: fixed;
    width: 100%;
    height: 100%;

    z-index: -1;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(1px);
}
.modal-content {
    max-width: 100%;
    max-height: 100%;
    display: flex;
    flex-direction: column;

    background-color: white;
    border: 1px solid black;
}
.modal-header, .modal-body, .modal-footer {
    padding: 20px;
}
.modal-header {
    border-bottom: 1px solid black;
}
.modal-body {
    overflow: auto;
}
.modal-footer {
    border-top: 1px solid black;
}

.icon-button {
    padding: 0;
    border: 0;
    background-color: transparent;
    appearance: none;
    cursor: pointer;
    color: #000;
    opacity: .5;
}
.icon-button:hover {
    opacity: .75;
}
.icon-button > .material-symbols-outlined {
    vertical-align: middle;
}
.opacity-half {
    opacity: .5;
}
.font-fill {
    font-variation-settings: 'FILL' 1;
}

    </style>

    <script src="ktv_data.js"></script>

    <script src="synk.js"></script>

</head>

<body class="d-flex">
    <div id="main" class="d-flex flex-column">
        <div id="nav" class="d-flex">
            <button id="back" class="icon-button">
                <i class="material-symbols-outlined">arrow_back</i>
            </button>
            <p id="title" class="flex-1 font-large">載入中...</p>
            <select id="company"></select>
        </div>
        <input id="search" list="searchList" type="search" placeholder="搜尋">
        <datalist id="searchList"></datalist>
        <div id="filterBar" class="d-flex">
            <label>
                <input id="favCheckbox" type="checkbox">
                我的最愛
            </label>
            <div class="flex-1"></div>
            <select id="selectStart">
                <option value=""></option>
            </select>
            <pre> ~ </pre>
            <select id="selectEnd">
                <option value=""></option>
            </select>
        </div>
        <div id="items" class="d-flex flex-column"></div>
    </div>

    <div id="detailModal" class="modal">
        <div class="backdrop"></div>
        <div class="modal-content">
            <div class="modal-header d-flex">
                <p class="flex-1">歌曲資訊</p>
                <button class="icon-button">
                    <i class="material-symbols-outlined modal-close-button">close</i>
                </button>
            </div>
            <div id="detail" class="modal-body"></div>
        </div>
    </div>

    <script>

(function() {

    if ("serviceWorker" in navigator && new URL(location.href).protocol === "https:")
        navigator.serviceWorker.register("service_worker.js")

    function $(selectors, element=document) {
        return element.querySelector(selectors)
    }
    function $$(selectors, element=document) {
        return Array.from(element.querySelectorAll(selectors))
    }
    function $on(type, elements, handler) {
        if (!Array.isArray(elements))
            elements = [elements]
        const processed = []
        for (const element of elements) {
            if (typeof element === "string")
                processed.push(...$$(element))
            else
                processed.push(element)
        }
        processed.forEach(element => element.addEventListener(type, handler))
    }
    function $html(html) {
        const template = document.createElement("template")
        template.innerHTML = html
        return template.content.children[0]
    }
    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;").replace(/'/g, "&#039;")
    }

    function openModal(selectors) {
        $(selectors).classList.add("modal-open")
        if (!history.state || !history.state.modalOpen)
            history.pushState({modalOpen: selectors}, "")
    }
    function closeModal() {
        $$(".modal.modal-open").forEach(element =>
            element.classList.remove("modal-open"))
        if (history.state && history.state.modalOpen)
            history.back()
    }
    $on("popstate", window, e => {
        if (history.state && history.state.modalOpen)
            openModal(history.state.modalOpen)
        else
            closeModal()
    })
    $on("click",
        [".modal .backdrop", ".modal .modal-close-button"],
        event => {
            if (event.target === event.currentTarget)
                closeModal()
        }
    )

    class KtvData {
        static allCompanies(songs) {
            let res = new Set()
            for (const song of songs) {
                if (!("code" in song))
                    continue
                for (const [company, code] of song.code)
                    res.add(company)
            }
            res = Array.from(res)
            res.sort()
            return res
        }
        static filterSinger(singers, keyword) {
            const res = []
            for (const singer of singers)
                if (singer.name.includes(keyword))
                    res.push(singer)
            return res
        }
        static filterSong(songs, keyword, keys=["name", "singer", "albumName"]) {
            const res = []
            for (const song of songs) {
                for (const key of keys) {
                    if (!(key in song))
                        continue
                    let values = song[key]
                    if (!Array.isArray(values))
                        values = [values]
                    if (values.some(v => v.includes(keyword))) {
                        res.push(song)
                        break
                    }
                }
            }
            return res
        }

        static isFavSinger(singer, favSingers) {
            return favSingers.includes(singer.name)
        }
        static removeFavSinger(singer, favSingers) {
            return favSingers.filter(favSinger => singer.name !== favSinger)
        }
        static addFavSinger(singer, favSingers) {
            return favSingers.concat([singer.name])
        }
        static toggleFavSinger(singer, favSingers) {
            if (KtvData.isFavSinger(singer, favSingers))
                return [false, KtvData.removeFavSinger(singer, favSingers)]
            else
                return [true, KtvData.addFavSinger(singer, favSingers)]
        }

        static favSongsTable(favSongs) {
            const nameSet = new Set()
            const singerTable = {}
            for (const [name, singer] of favSongs) {
                if (!nameSet.has(name)) {
                    nameSet.add(name)
                    singerTable[name] = new Set()
                }
                singerTable[name].add(singer)
            }
            return [nameSet, singerTable]
        }
        static isFavSong(song, favSongsTable) {
            const [nameSet, singerTable] = favSongsTable
            if (!("name" in song) || !("singer" in song))
                return false
            let names = song.name
            let singers = song.singer
            if (!Array.isArray(names))
                names = [names]
            if (!Array.isArray(singers))
                singers = [singers]
            for (const name of names)
                if (nameSet.has(name) && singers.some(
                    singer => singerTable[name].has(singer)))
                    return true
            return false
        }
        static matchFavSong(song, favSong) {
            if (!("name" in song) || !("singer" in song))
                return false
            let names = song.name
            let singers = song.singer
            if (!Array.isArray(names))
                names = [names]
            if (!Array.isArray(singers))
                singers = [singers]
            const [name, singer] = favSong
            return names.includes(name) && singers.includes(singer)
        }
        static removeFavSong(song, favSongs) {
            return favSongs.filter(
                favSong => !KtvData.matchFavSong(song, favSong))
        }
        static addFavSong(song, favSongs) {
            if (!("name" in song) || !("singer" in song))
                return
            let names = song.name
            let singers = song.singer
            if (!Array.isArray(names))
                names = [names]
            if (!Array.isArray(singers))
                singers = [singers]
            return favSongs.concat([[names[0], singers[0]]])
        }
        static toggleFavSong(song, favSongs) {
            const favSongsTable = KtvData.favSongsTable(favSongs)
            if (KtvData.isFavSong(song, favSongsTable))
                return [false, KtvData.removeFavSong(song, favSongs)]
            else
                return [true, KtvData.addFavSong(song, favSongs)]
        }
    }

    class KtvApp {
        constructor(localStorageKey="kirksud_ktv_kkbox") {
            this.localStorageKey = localStorageKey
            
            $on("click", "#back", e => history.back())
            $on("change", "#company", e => this.onCompany())
            $on("change", "#search", e => this.onChange())
            $on("change", "#favCheckbox", e => this.onChange())
            $on("change", "#selectStart", e => this.onChange())
            $on("change", "#selectEnd", e => this.onChange())
            $on("popstate", window, e => this.onPopState())

            $("#company").innerHTML = `<option value="">未選擇</option>`
            for (const company of KtvData.allCompanies(ktvData.songs))
                $("#company").insertAdjacentHTML("beforeend", `
                    <option value="${company}">${company}</option>`)
            $("#company").value = this.load().company

            for (let y=new Date().getFullYear(); y>=1960; y--) {
                const h = `<option value="${y}">${y}</option>`
                $("#selectStart").insertAdjacentHTML("beforeend", h)
                $("#selectEnd").insertAdjacentHTML("beforeend", h)
            }

            const synkServer = "https://kirk.alwaysdata.net"
            // const synkServer = "https://kirksud.pythonanywhere.com"
            this.synk = new Synk(synkServer, "1MB", this.localStorageKey + "_synk")

            this.singer = null
            this.initDataList()
            this.show()
            this.sync()
        }

        load() {
            const data = JSON.parse(localStorage.getItem(this.localStorageKey) ?? "null") ?? {
                version: "0.1",
                company: "",
                favSongs: [],
                favSingers: [],
                doSync: false,
            }
            return data
        }
        save(data) {
            localStorage.setItem(this.localStorageKey, JSON.stringify(data))
            this.sync()
        }
        sync() {
            if (!this.load().doSync)
                return
            const localData = localStorage.getItem(this.localStorageKey) ?? "null"
            this.synk.run(localData, data => {
                if (data === null || data === localData)
                    return
                localStorage.setItem(this.localStorageKey, data)
                this.show()
            })
        }

        onCompany() {
            const data = this.load()
            data.company = $("#company").value
            this.save(data)
            this.show()
        }
        saveState() {
            history.replaceState({
                singer: this.singer,
                search: $("#search").value,
                fav: $("#favCheckbox").checked,
                start: $("#selectStart").value,
                end: $("#selectEnd").value,
                scroll: $("#items").scrollTop,
            }, "")
        }
        onChange() {
            this.show()
            this.saveState()
        }
        navigate(singer) {
            this.saveState()

            this.singer = singer
            $("#search").value = ""
            $("#favCheckbox").checked = false
            $("#selectStart").value = ""
            $("#selectEnd").value = ""

            history.pushState({}, "")
            this.show()
            this.saveState()
        }
        onPopState() {
            const s = history.state
            if (!s || !("singer" in s))
                return
            this.singer = s.singer
            $("#search").value = s.search
            $("#favCheckbox").checked = s.fav
            $("#selectStart").value = s.start
            $("#selectEnd").value = s.end

            this.show()
            $("#items").scrollTop = s.scroll
        }

        filterSinger() {
            let singers = ktvData.singers
            if ($("#favCheckbox").checked) {
                const favSingers = this.load().favSingers
                singers = singers.filter(singer => KtvData.isFavSinger(singer, favSingers))
            }

            let startYear = $("#selectStart").value
            let endYear = $("#selectEnd").value
            if (startYear === "" && endYear === "")
                return singers
            startYear = (startYear === "") ? -Infinity : Number(startYear)
            endYear = (endYear === "") ? Infinity : Number(endYear)

            const res = []
            for (const singer of singers) {
                const singerYear = ("first" in singer) ?
                    new Date(singer.first).getFullYear() :
                    (singer.album ?? singer.guessAlbum ?? 0)
                if (singerYear >= startYear && singerYear <= endYear)
                    res.push(singer)
            }
            return res
        }
        filterSong() {
            let songs = ktvData.songs
            if ($("#favCheckbox").checked) {
                const favSongsTable = KtvData.favSongsTable(this.load().favSongs)
                songs = songs.filter(song => KtvData.isFavSong(song, favSongsTable))
            }

            let startYear = $("#selectStart").value
            let endYear = $("#selectEnd").value
            if (startYear === "" && endYear === "")
                return songs
            startYear = (startYear === "") ? -Infinity : Number(startYear)
            endYear = (endYear === "") ? Infinity : Number(endYear)

            const res = []
            for (const song of songs) {
                const songDate = ("rankings" in song) ?
                    song.rankings.first :
                    (song.releaseDate ?? song.albumDate)
                const songYear = songDate ? new Date(songDate).getFullYear() : 0
                if (songYear >= startYear && songYear <= endYear)
                    res.push(song)
            }
            return res
        }

        initDataList() {
            let values
            if (this.singer === "")
                values = ktvData.singers.map(singer => singer.name)
            else {
                let songs = ktvData.songs
                if (this.singer !== null)
                    songs = KtvData.filterSong(songs, this.singer, ["singer"])
                values = songs.filter(song => "name" in song)
                    .map(song => Array.isArray(song.name) ? song.name[0] : song.name)
            }
            for (const v of values)
                $("#searchList").insertAdjacentHTML("beforeend", `
                    <option value="${v}"></option>`)
        }
        show() {
            if (this.singer === null)
                this.showSongs()
            else if (this.singer === "")
                this.showSingers()
            else
                this.showSingerSongs()
        }
        showSongs() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (search === "") ? "所有歌曲" : `歌曲「${search}」`

            if (search === "dosynk") {
                const data = this.load()
                data.doSync = !data.doSync
                this.save(data)
            }
            $("#items").appendChild(
                this.simpleItem("arrow_forward", "所有歌手",
                    e => this.navigate("")))

            const songs = this.filterSong()
            this.appendSongs(KtvData.filterSong(songs, search))
        }
        showSingers() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (search === "") ? "所有歌手" : `歌手「${search}」`
            const singers = this.filterSinger()
            this.appendSingers(KtvData.filterSinger(singers, search))
        }
        showSingerSongs() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (
                search === "") ? `「${this.singer}」的歌曲` : `「${this.singer}」的「${search}」`
            const songs = this.filterSong()
            const singerSongs = KtvData.filterSong(songs, this.singer, ["singer"])
            this.appendSongs(KtvData.filterSong(singerSongs, search))
        }

        simpleItem(icon, text, click) {
            const element = $html(`
                <div>
                    <div class="d-flex">
                        <i class="material-symbols-outlined opacity-half">${icon}</i>
                        <p class="font-large">${text}</p>
                    </div>
                </div>`)
            $on("click", element, click)
            return element
        }
        clearSearch() {
            $("#search").value = ""
            $("#favCheckbox").checked = false
            $("#selectStart").value = ""
            $("#selectEnd").value = ""
            this.show()
        }

        appendSongs(songs) {
            const maxItems = 500
            const selectedCompany = $("#company").value
            const favSongsTable = KtvData.favSongsTable(this.load().favSongs)
            $("#title").innerText = `(${songs.length}首) ` + $("#title").innerText

            for (const song of songs.slice(0, maxItems)) {
                let name = ""
                let singer = ""
                let lang = ""
                if ("name" in song)
                    name = Array.isArray(song.name) ? song.name[0] : song.name
                if ("singer" in song)
                    singer = Array.isArray(song.singer) ? song.singer[0] : song.singer
                if ("lang" in song)
                    lang = Array.isArray(song.lang) ? song.lang[0] : song.lang

                let code = ""
                if ("code" in song && selectedCompany === "")
                    code = (song.code.length === 1) ?
                        song.code[0][1] : `${song.code.length}個`
                else if ("code" in song && selectedCompany !== "") {
                    code = song.code
                        .filter(([company, code]) => company === selectedCompany)
                        .map(([company, code]) => code)
                    code = (code.length === 1) ? code[0] : code.join(" / ")
                }
                let company = ""
                if ("code" in song && code !== "")
                    company = (selectedCompany !== "") ? selectedCompany : (
                        (song.code.length === 1) ? song.code[0][0] : `${song.code.length}個`)
                if (code === "")
                    code = "無"
                const isFavSong = KtvData.isFavSong(song, favSongsTable)

                let html = `
                    <div class="d-flex font-large">
                        <button class="icon-button ${isFavSong ? "font-fill" : ""}">
                            <i class="material-symbols-outlined">star</i>
                        </button>
                        <p class="flex-1">${escapeHtml(name)}</p>
                        <p>${code}</p>
                    </div>
                    <div class="d-flex">
                        <p class="flex-1">${escapeHtml(singer)}</p>
                        <p>${lang} / ${company}</p>
                    </div>`

                if ("rankings" in song) {
                    const r = song.rankings
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">${r.score} 分 / ${r.weeks} 次</p>
                            <p>#${r.top} / ${r.first} ~ ${r.last}</p>
                        </div>`
                }
                else if ("releaseDate" in song) {
                    const d = Array.isArray(song.releaseDate) ? song.releaseDate[0] : song.releaseDate
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">發行 ${d}</p>
                        </div>`
                }
                else if ("albumDate" in song) {
                    const d = Array.isArray(song.albumDate) ? song.albumDate[0] : song.albumDate
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">專輯發行 ${d}</p>
                        </div>`
                }

                const element = $html(`<div>${html}</div>`)
                $on("click", $("button", element), e => this.toggleFavSong(e, song))
                $on("click", element, e => this.showDetail(song))
                $("#items").appendChild(element)
            }
            if (songs.length === 0)
                $("#items").appendChild(
                    this.simpleItem("close", "無結果", e => this.clearSearch()))
        }

        appendSingers(singers) {
            const maxItems = 500
            const favSingers = this.load().favSingers
            $("#title").innerText = `(${singers.length}位) ` + $("#title").innerText

            for (const singer of singers.slice(0, maxItems)) {
                const isFavSinger = KtvData.isFavSinger(singer, favSingers)
                let html = `
                    <div class="d-flex">
                        <button class="icon-button ${isFavSinger ? "font-fill" : ""}">
                            <i class="material-symbols-outlined">star</i>
                        </button>
                        <p class="flex-1 font-large">${escapeHtml(singer.name)}</p>
                        <p>${singer.count} 首</p>
                    </div>`
                if ("score" in singer)
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">${singer.score} 分 / ${singer.weeks} 次</p>
                            <p>#${singer.top} / ${singer.first} ~ ${singer.last}</p>
                        </div>`
                else if (["start", "end", "birth", "album"].some(i => i in singer)) {
                    html += `<div class="d-flex font-small">`
                    html += `<p class="flex-1">`
                    if ("birth" in singer)
                        html += `${singer.birth} 生`
                    else if (("start" in singer) || ("end" in singer))
                        html += `${singer.start ?? ""} ~ ${singer.end ?? ""}`
                    html += "</p>"
                    if ("album" in singer)
                        html += `<p>首發 ${singer.album}</p>`
                    html += "</div>"
                }
                const element = $html(`<div>${html}</div>`)
                $on("click", $("button", element), e => this.toggleFavSinger(e, singer))
                $on("click", element, e => this.navigate(singer.name))
                $("#items").appendChild(element)
            }
            if (singers.length === 0)
                $("#items").appendChild(
                    this.simpleItem("close", "無結果", e => this.clearSearch()))
        }

        toggleFavSong(event, song) {
            event.stopPropagation()
            if (!("name" in song) || !("singer" in song))
                return
            const data = this.load()
            let isFav
            [isFav, data.favSongs] = KtvData.toggleFavSong(song, data.favSongs)
            if (isFav)
                event.currentTarget.classList.add("font-fill")
            else
                event.currentTarget.classList.remove("font-fill")
            this.save(data)
        }
        toggleFavSinger(event, singer) {
            event.stopPropagation()
            const data = this.load()
            let isFav
            [isFav, data.favSingers] = KtvData.toggleFavSinger(singer, data.favSingers)
            if (isFav)
                event.currentTarget.classList.add("font-fill")
            else
                event.currentTarget.classList.remove("font-fill")
            this.save(data)
        }

        showDetail(song) {
            function addInfoBlock(key, title, formatter=null) {
                if (!(key in song))
                    return
                let values = song[key]
                if (!Array.isArray(values))
                    values = [values]
                if (key === "code")
                    values.sort()
                if ($("#detail").innerHTML !== "")
                    $("#detail").insertAdjacentHTML("beforeend", "<hr>")
                $("#detail").insertAdjacentHTML("beforeend",
                    `<p class="font-bold">${title}</p>`)
                for (let value of values) {
                    if (formatter === null) {
                        if ((typeof value) !== "string")
                            value = `${value}`
                        $("#detail").insertAdjacentHTML("beforeend",
                            `<p>${escapeHtml(value)}</p>`)
                    }
                    else
                        $("#detail").insertAdjacentHTML("beforeend",
                            formatter(value))
                }
            }

            const fields = {
                "name": "曲名",
                // "subname": "副名稱",
                "singer": "歌手",
                "albumName": "專輯",
                "releaseDate": "發行日",
                "albumDate": "專輯發行日",
                "lang": "語言",
                "sex": "性別",
                // "isVariousArtists": "多作者",
                "code": "KTV 代碼",
                // "songDate": "KTV 日期"
            }
            const rankingFields = {
                "score": "總分",
                "top": "最高排名",
                "weeks": "上榜週數",
                "first": "初次上榜",
                "last": "最後上榜",
            }
            const linkFields = {
                "youtubeID": ["YouTube", "https://youtu.be/"],
                "trackID": ["KKBOX 歌曲", "https://www.kkbox.com/tw/tc/song/"],
                "artistID": ["KKBOX 歌手", "https://www.kkbox.com/tw/tc/artist/"],
                "albumID": ["KKBOX 專輯", "https://www.kkbox.com/tw/tc/album/"]
            }

            $("#detail").innerHTML = ""
            for (const [key, title] of Object.entries(fields)) {
                if (key === "code")
                    addInfoBlock(key, title, ([company, code]) => `<p>${company}: ${code}</p>`)
                else
                    addInfoBlock(key, title)
            }
            if ("rankings" in song) {
                $("#detail").insertAdjacentHTML("beforeend", "<hr>")
                $("#detail").insertAdjacentHTML("beforeend",
                    `<p class="font-bold">KKBOX 華語單曲週榜</p>`)
                for (const [key, title] of Object.entries(rankingFields))
                    $("#detail").insertAdjacentHTML("beforeend",
                        `<p>${title}: ${song.rankings[key]}</p>`)
            }
            for (const [key, [title, linkPrefix]] of Object.entries(linkFields))
                addInfoBlock(key, title,
                    value => `<p><a target="_blank" href="${linkPrefix}${value}">${value}</a></p>`)
            openModal("#detailModal")
            $("#detail").scrollTop = 0
        }
    }
    $on("load", window, e => new KtvApp())

})()

    </script>
</body>
</html>
