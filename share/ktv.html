<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="utf-8" />
    <title>KTV KKBOX</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1, user-scalable=no">

    <meta name="description" content="KTV號碼查詢、KKBOX華語單曲週榜、音樂播放器">
    <meta property="og:title" content="KTV KKBOX">
    <meta property="og:description" content="KTV號碼查詢、KKBOX華語單曲週榜、音樂播放器">
    <meta property="og:url" content="https://kirksud.github.io/share/ktv.html">
    <meta name="twitter:card" content="summary">
    <meta property="og:site_name" content="kirksud.github.io">

    <link rel="icon" href="icon/music.svg" sizes="any" type="image/svg+xml">
    <link rel="icon" href="icon/music_512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="icon/music_192.png" sizes="192x192" type="image/png">

    <link rel="manifest" href="manifest/ktv.json">

    <link rel="stylesheet" crossorigin="anonymous"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1">

    <style>

html {
    height: 100%;
}
body {
    margin: 0;
    height: 100%;
    justify-content: center;
    overflow-y: hidden; /* to disable chrome mobile pull-to-refresh */
}
p, pre {
    margin: 0;
}

#main {
    width: 100%;
    max-width: 576px;
    padding-top: 1vh;
}
#nav, #search, #filterBar {
    margin: 1vh 3vmin;
}
#singerButton {
    align-items: center;
}
#items {
    overflow: auto;
    margin-top: 1vh;
}
#items > div:nth-child(2n+1) {
    background-color: rgb(240, 240, 240);
}
#items > div:first-child {
    border-top: 1px solid rgb(200, 200, 200);
}
#items > div {
    border-bottom: 1px solid rgb(200, 200, 200);
    padding: 1vh 3vmin;
    cursor: pointer;
    user-select: none;
}
#items > div > div {
    margin: 1.5vh 0;
}
#items .flex-1 {
    margin-right: 0.5em;
}
#title, #company, #search, #selectStart, #selectEnd {
    padding: 1vh 0.5vw;
}
#nav, #filterBar {
    align-items: center;
}
#filterBar label {
    user-select: none;
}
#detail > p {
    margin: 1vh 0;
}
#detail > hr {
    margin: 2vh 0;
}

#player {
    border-top: 1px solid rgb(200, 200, 200);
    display: none;
}
#player.player-open {
    display: flex;
}
#player.player-minimize #playerCaptionsContainer,
#player.player-minimize #playerTitleContainer,
#player.player-minimize #playerButtons {
    display: none;
}
#player.player-no-captions #playerCaptionsContainer {
    display: none;
}
#player.player-no-captions #playerTitleContainer {
    padding-top: 1vh;
}
#player > * > p {
    margin: 1vh 1vw;
}
#player > * > button {
    padding: 1vh 1vw;
}
#playerCaptionsContainer, #playerTitleContainer, #playerButtons {
    padding: 0 4vmin;
}
#playerCaptionsContainer {
    justify-content: center;
    border-bottom: 1px solid rgb(200, 200, 200);
}
#playerButtons {
    justify-content: space-evenly;
}
#playerCaptions {
    color: white;
    background-color: rgb(80, 80, 80);
    padding: 0.4em;
    border-radius: 0.4em;
    cursor: pointer;
}

.v-hidden {
    visibility: hidden;
}
.d-none {
    display: none;
}
.d-flex {
    display: flex;
}
.flex-column {
    flex-direction: column;
}
.flex-1 {
    flex: 1;
}
.font-small {
    font-size: small;
}
.font-large {
    font-size: large;
}
.font-bold {
    font-weight: bold;
}

.modal {
    position: fixed;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    padding: 3vmin;
    display: none;
}
.modal-open {
    display: flex;
    justify-content: center;
    align-items: center;
}
.backdrop {
    position: fixed;
    width: 100%;
    height: 100%;

    z-index: -1;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(1px);
}
.modal-content {
    max-width: 100%;
    max-height: 100%;
    display: flex;
    flex-direction: column;

    background-color: white;
    border: 1px solid black;
}
.modal-header, .modal-body, .modal-footer {
    padding: 20px;
}
.modal-header {
    border-bottom: 1px solid black;
}
.modal-body {
    overflow: auto;
}
.modal-footer {
    border-top: 1px solid black;
}

.icon-button {
    padding: 0;
    border: 0;
    background-color: transparent;
    appearance: none;
    cursor: pointer;
    color: #000;
    opacity: .5;
}
.icon-button:hover {
    opacity: .75;
}
.icon-button > .material-symbols-outlined {
    vertical-align: middle;
}
.font-fill {
    font-variation-settings: 'FILL' 1;
}

    </style>

    <script src="ktv_data.js"></script>

    <script src="synk.js"></script>

</head>

<body class="d-flex">
    <div id="main" class="d-flex flex-column">
        <div id="nav" class="d-flex">
            <button id="back" class="icon-button">
                <i class="material-symbols-outlined">arrow_back</i>
            </button>
            <p id="title" class="flex-1 font-large">載入中...</p>
            <select id="company"></select>
        </div>
        <input id="search" type="search" placeholder="搜尋">
        <div id="filterBar" class="d-flex">
            <label>
                <input id="favCheckbox" type="checkbox">
                我的最愛
            </label>
            <div class="flex-1"></div>
            <button id="singerButton" class="d-none">
                <i class="material-symbols-outlined">arrow_forward</i>
                歌手
            </button>
            <div class="flex-1"></div>
            <select id="selectStart">
                <option value=""></option>
            </select>
            <pre> ~ </pre>
            <select id="selectEnd">
                <option value=""></option>
            </select>
        </div>
        <div id="items" class="d-flex flex-column flex-1"></div>
        <div id="player" class="flex-column">
            <div id="playerCaptionsContainer" class="d-flex">
                <p id="playerCaptions" class="v-hidden">歌詞</p>
            </div>
            <div id="playerTitleContainer" class="d-flex">
                <p id="playerSong" class="flex-1 font-large">歌名</p>
                <p id="playerSinger">歌手</p>
            </div>
            <div id="playerButtons" class="d-flex">
                <button id="playerMode" class="icon-button">
                    <i class="material-symbols-outlined">looks_one</i>
                </button>
                <button id="playerPrev" class="icon-button font-fill">
                    <i class="material-symbols-outlined">skip_previous</i>
                </button>
                <button id="playerRewind" class="icon-button">
                    <i class="material-symbols-outlined">replay_10</i>
                </button>
                <button id="playerPlay" class="icon-button font-fill">
                    <i class="material-symbols-outlined">play_arrow</i>
                </button>
                <button id="playerForward" class="icon-button">
                    <i class="material-symbols-outlined">forward_10</i>
                </button>
                <button id="playerNext" class="icon-button font-fill">
                    <i class="material-symbols-outlined">skip_next</i>
                </button>
                <button id="playerLink" class="icon-button">
                    <i class="material-symbols-outlined">open_in_new</i>
                </button>
            </div>
            <div class="d-flex">
                <audio class="flex-1" controls crossorigin="anonymous">
                    <track default kind="captions" />
                </audio>
                <button id="playerMinimize" class="icon-button">
                    <i class="material-symbols-outlined">keyboard_arrow_down</i>
                </button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="backdrop"></div>
        <div class="modal-content">
            <div class="modal-header d-flex">
                <p class="flex-1">歌曲資訊</p>
                <button class="icon-button">
                    <i class="material-symbols-outlined modal-close-button">close</i>
                </button>
            </div>
            <div id="detail" class="modal-body"></div>
        </div>
    </div>

    <div id="ytapApproveModal" class="modal">
        <div class="backdrop"></div>
        <div class="modal-content">
            <div class="modal-header d-flex">
                <p class="flex-1">開通播放服務</p>
                <button class="icon-button">
                    <i class="material-symbols-outlined modal-close-button">close</i>
                </button>
            </div>
            <div class="modal-body">
                需開通播放服務，請告知網站管理員開通代碼為「
                <span class="font-bold"></span>
                」（代碼 10 分鐘內有效）
            </div>
        </div>
    </div>

    <div id="lyricsModal" class="modal">
        <div class="backdrop"></div>
        <div class="modal-content">
            <div class="modal-header d-flex">
                <p class="flex-1">歌詞</p>
                <button class="icon-button">
                    <i class="material-symbols-outlined modal-close-button">close</i>
                </button>
            </div>
            <div id="lyrics" class="modal-body"></div>
        </div>
    </div>

    <script>

(function() {

    if ("serviceWorker" in navigator && new URL(location.href).protocol === "https:")
        navigator.serviceWorker.register("service_worker.js")

    function $(selectors, element=document) {
        return element.querySelector(selectors)
    }
    function $$(selectors, element=document) {
        return Array.from(element.querySelectorAll(selectors))
    }
    function $on(type, elements, handler) {
        if (!Array.isArray(elements))
            elements = [elements]
        const processed = []
        for (const element of elements) {
            if (typeof element === "string")
                processed.push(...$$(element))
            else
                processed.push(element)
        }
        processed.forEach(element => element.addEventListener(type, handler))
    }
    function $html(html) {
        const template = document.createElement("template")
        template.innerHTML = html
        return template.content.children[0]
    }
    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;").replace(/'/g, "&#039;")
    }

    class Modal {
        constructor(saveStateFunc=null) {
            this.saveStateFunc = saveStateFunc
            $on("popstate", window, e => {
                if (history.state && history.state.modalOpen)
                    this.openModal(history.state.modalOpen)
                else
                    this.closeModal()
            })
            $on("click",
                [".modal .backdrop", ".modal .modal-close-button"],
                event => {
                    if (event.target === event.currentTarget)
                        this.closeModal()
                }
            )
        }
        openModal(selectors) {
            if (this.saveStateFunc)
                this.saveStateFunc()
            $(selectors).classList.add("modal-open")
            if (!history.state || !history.state.modalOpen)
                history.pushState({modalOpen: selectors}, "")
        }
        closeModal() {
            $$(".modal.modal-open").forEach(element =>
                element.classList.remove("modal-open"))
            if (history.state && history.state.modalOpen)
                history.back()
        }
    }

    class KtvData {
        static toArray(obj) {
            return Array.isArray(obj) ? obj : [obj]
        }
        static allCompanies(songs) {
            let res = new Set()
            for (const song of songs) {
                if (!("code" in song))
                    continue
                for (const [company, code] of song.code)
                    res.add(company)
            }
            res = Array.from(res)
            res.sort()
            return res
        }
        static filterSinger(singers, keyword) {
            const res = []
            for (const singer of singers)
                if (singer.name.includes(keyword))
                    res.push(singer)
            return res
        }
        static filterSong(songs, keyword, keys, split=false) {
            function songKeyIncludes(song, key, keyword) {
                if (!(key in song))
                    return false
                let values = KtvData.toArray(song[key])
                if (key === "code")
                    values = values.map(([company, code]) => code)
                return values.some(v => v.includes(keyword))
            }

            const keywords = split ? keyword.split(" ") : [keyword]
            return songs.filter(
                song => keywords.every(
                    word => keys.some(
                        key => songKeyIncludes(song, key, word)
                    )
                )
            )
        }

        static isFavSinger(singer, favSingers) {
            return favSingers.includes(singer.name)
        }
        static removeFavSinger(singer, favSingers) {
            return favSingers.filter(favSinger => singer.name !== favSinger)
        }
        static addFavSinger(singer, favSingers) {
            return favSingers.concat([singer.name])
        }
        static toggleFavSinger(singer, favSingers) {
            if (KtvData.isFavSinger(singer, favSingers))
                return [false, KtvData.removeFavSinger(singer, favSingers)]
            else
                return [true, KtvData.addFavSinger(singer, favSingers)]
        }

        static favSongsTable(favSongs) {
            const nameSet = new Set()
            const singerTable = {}
            for (const [name, singer] of favSongs) {
                if (!nameSet.has(name)) {
                    nameSet.add(name)
                    singerTable[name] = new Set()
                }
                singerTable[name].add(singer)
            }
            return [nameSet, singerTable]
        }
        static isFavSong(song, favSongsTable) {
            const [nameSet, singerTable] = favSongsTable
            if (!("name" in song) || !("singer" in song))
                return false
            const names = KtvData.toArray(song.name)
            const singers = KtvData.toArray(song.singer)
            for (const name of names)
                if (nameSet.has(name) && singers.some(
                    singer => singerTable[name].has(singer)))
                    return true
            return false
        }
        static matchFavSong(song, favSong) {
            if (!("name" in song) || !("singer" in song))
                return false
            const names = KtvData.toArray(song.name)
            const singers = KtvData.toArray(song.singer)
            const [name, singer] = favSong
            return names.includes(name) && singers.includes(singer)
        }
        static removeFavSong(song, favSongs) {
            return favSongs.filter(
                favSong => !KtvData.matchFavSong(song, favSong))
        }
        static addFavSong(song, favSongs) {
            if (!("name" in song) || !("singer" in song))
                return
            const names = KtvData.toArray(song.name)
            const singers = KtvData.toArray(song.singer)
            return favSongs.concat([[names[0], singers[0]]])
        }
        static toggleFavSong(song, favSongs) {
            const favSongsTable = KtvData.favSongsTable(favSongs)
            if (KtvData.isFavSong(song, favSongsTable))
                return [false, KtvData.removeFavSong(song, favSongs)]
            else
                return [true, KtvData.addFavSong(song, favSongs)]
        }
    }

    class PlayerWidget {
        constructor(ktvApp, urlPrefix="https://ytppap.alwaysdata.net/ytap") {
            this.ktvApp = ktvApp
            this.urlPrefix = urlPrefix

            this.token = null
            this.playing = false
            this.mode = "one"

            $on("click", "#playerMode", e => this.switchNextMode())
            $on("click", "#playerPrev", e => this.prev())
            $on("click", "#playerNext", e => this.next())
            $on("click", "#playerLink", e => this.onLink())
            $on("click", "#playerPlay", e => this.playPause())

            $on("play", "#player audio", e => this.onPlay())
            $on("pause", "#player audio", e => this.onPause())
            $on("ended", "#player audio", e => this.onEnd())
            $on("error", "#player audio", e => this.onEnd())
            $on("canplay", "#player audio", e => e.currentTarget.play())

            $on("click", "#playerRewind", e => this.seekBackward())
            $on("click", "#playerForward", e => this.seekForward())
            $on("click", "#playerMinimize", e => this.toggleMinimize())

            $on("load", "#player track", e => $("#player").classList.remove("player-no-captions"))
            $on("error", "#player track", e => $("#player").classList.add("player-no-captions"))
            $on("cuechange", $("#player audio").textTracks[0], e => this.onCueChange())
            $on("click", $("#playerCaptions"), e => this.onClickCaptions())

            $on("keydown", document, e => this.onKeyDown(e))
            if ("mediaSession" in navigator) {
                const actionTypes = [
                    "play", "pause", "stop",
                    "previoustrack", "nexttrack",
                    "seekbackward", "seekforward", "seekto",
                ]
                for (const actionType of actionTypes)
                    navigator.mediaSession.setActionHandler(actionType,
                        (action, fastSeek, seekOffset, seekTime) => this.onMediaAction(
                            action, fastSeek, seekOffset, seekTime))
            }
        }

        async request(urlPostfix) {
            try {
                const resp = await fetch(this.urlPrefix + urlPostfix)
                if (!resp.ok) {
                    console.log("fetch error: ServerError:", urlPostfix,
                        `${resp.status} ${resp.statusText}`, resp)
                    return [null, "ServerError"]
                }
                const res = await resp.json()
                return [res, null]
            } catch (e) {
                console.log("fetch error: NetworkError:", urlPostfix, e)
                return [null, "NetworkError"]
            }
        }
        async getToken() {
            function notifyError(err) {
                alert({
                    "ServerError": "伺服器錯誤，請稍後再試。",
                    "NetworkError": "網路錯誤，請檢查網路連線。",
                }[err])
            }

            let token = this.ktvApp.load().ytapToken
            if (token) {
                const [res, err] = await this.request("/token/" + token)
                if (err) {
                    notifyError(err)
                    return null
                }
                if (res.status)
                    return token
            }

            const [res, err] = await this.request("/token")
            if (err) {
                notifyError(err)
                return null
            }
            let code
            ({code, token} = res)
            const data = this.ktvApp.load()
            data.ytapToken = token
            this.ktvApp.save(data)
            $("#ytapApproveModal .modal-body span").innerText = code
            this.ktvApp.modal.openModal("#ytapApproveModal")
            return null
        }
        async playPauseSong(song, newSongList=false) {
            function shuffle(arr, inplace=false) {
                const res = inplace ? arr : Array.from(arr)
                for (let i=res.length-1; i>=0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [res[i], res[j]] = [res[j], res[i]]
                }
                return res
            }

            const ytid = KtvData.toArray(song.youtubeID)[0]
            const ktvAppState = this.ktvApp.currentState()
            const songs = this.ktvApp.filterSong()
            if (ytid === this.ytid) {
                this.playPause()
                return
            }

            this.token = this.token ?? (await this.getToken())
            if (this.token === null)
                return

            this.song = song
            this.ytid = ytid
            if (newSongList) {
                this.ktvAppState = ktvAppState
                this.songs = songs
                this.shuffled = shuffle(songs)
            }

            let langs = new Set(navigator.languages)
            for (const lang of navigator.languages)
                langs.add(lang.split("-")[0])
            langs = Array.from(langs).join("_")

            const name = KtvData.toArray(song.name ?? [""])[0]
            const singer = KtvData.toArray(song.singer ?? [""])[0]
            const album = KtvData.toArray(song.album ?? [""])[0]
            if ("mediaSession" in navigator)
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: name,
                    artist: singer,
                    album: album,
                })
            $("#playerCaptions").classList.add("v-hidden")
            $("#playerSong").innerText = name
            $("#playerSinger").innerText = singer
            $("#player audio").src = this.urlPrefix + `/audio/${this.token}/${this.ytid}`
            $("#player track").src = this.urlPrefix + `/vtt/${this.token}/${this.ytid}/${langs}`
            $("#player").classList.add("player-open")
        }

        onPlay() {
            this.playing = true
            $("#playerPlay .material-symbols-outlined").innerText = "pause"
            this.updatePlayIcons()
        }
        onPause() {
            this.playing = false
            $("#playerPlay .material-symbols-outlined").innerText = "play_arrow"
            this.updatePlayIcons()
        }
        playPause() {
            if (this.playing)
                $("#player audio").pause()
            else
                $("#player audio").play()
        }
        playReplay() {
            if (this.playing)
                $("#player audio").currentTime = 0
            else
                $("#player audio").play()
        }

        switchMode(mode) {
            this.mode = mode
            $("#playerMode .material-symbols-outlined").innerText = {
                "one": "looks_one",
                "all": "repeat",
                "shuffle": "shuffle",
                "repeat": "repeat_one",
            }[mode]
        }
        switchNextMode() {
            const modes = ["one", "all", "shuffle", "repeat"]
            let idx = modes.indexOf(this.mode)
            idx = (idx + 1) % modes.length
            this.switchMode(modes[idx])
        }
        toggleMinimize() {
            if ($("#player").classList.contains("player-minimize")) {
                $("#player").classList.remove("player-minimize")
                $("#playerMinimize .material-symbols-outlined").innerText = "keyboard_arrow_down"
            }
            else {
                $("#player").classList.add("player-minimize")
                $("#playerMinimize .material-symbols-outlined").innerText = "keyboard_arrow_up"
            }
        }
        onCueChange() {
            const cues = $("#player audio").textTracks[0].activeCues
            if (cues.length === 0)
                $("#playerCaptions").classList.add("v-hidden")
            else {
                $("#playerCaptions").innerHTML = ""
                $("#playerCaptions").appendChild(cues[0].getCueAsHTML().cloneNode(true))
                $("#playerCaptions").classList.remove("v-hidden")
            }
        }
        onClickCaptions() {
            const cues = $("#player audio").textTracks[0].cues
            const lyrics = $("#lyrics")
            lyrics.innerHTML = ""

            let lastText = ""
            let lastEnd = Infinity
            for (const cue of cues) {
                const p = document.createElement("p")
                p.appendChild(cue.getCueAsHTML().cloneNode(true))
                const text = p.innerText.replace(/\p{C}/gu, "")
                // \p{C} matches invisible control characters and unused code points
                // because "Zero-width space" was found in a vtt before
                if (text === lastText)
                    continue
                if (cue.startTime - lastEnd > 10)
                    lyrics.insertAdjacentHTML("beforeend", `<br />`)
                lyrics.appendChild(p)
                lastText = text
                lastEnd = cue.endTime
            }
            this.ktvApp.modal.openModal("#lyricsModal")
        }

        matchSong(song, ytid) {
            return ("youtubeID" in song) && KtvData.toArray(song.youtubeID)[0] === ytid
        }
        indexOf(songs, ytid) {
            return Array.from(songs.entries())
                .filter(([i, song]) => this.matchSong(song, ytid))
                .map(([i, song]) => i)[0]
        }
        updatePlayIcons() {
            const icons = $$("#items .play-btn .material-symbols-outlined")
            for (const [i, song] of this.ktvApp.filterSong().entries()) {
                if (i >= icons.length)
                    break
                const playing = this.playing && this.matchSong(song, this.ytid)
                if ((icons[i].innerText !== "pause") === playing)
                    icons[i].innerText = playing ? "pause" : "play_arrow"
            }
        }
        nextSong(songs, diff=1) {
            songs = KtvData.filterSong(songs, "", ["youtubeID"])
            let idx = this.indexOf(songs, this.ytid)
            idx = (idx + diff + songs.length) % songs.length
            return songs[idx]
        }
        onLink() {
            if (this.mode === "one" || this.mode === "repeat") {
                this.ktvApp.showDetail(this.song)
                return
            }
            this.ktvApp.navigate(this.ktvAppState)
            const idx = this.indexOf(this.ktvApp.filterSong(), this.ytid)
            const items = $$("#items > div")
            if (idx < items.length)
                items[idx].scrollIntoView(true)
            else
                this.ktvApp.showDetail(this.song)
        }

        onEnd() {
            if (this.mode === "repeat")
                this.playPause()
            else if (this.mode === "all")
                this.playPauseSong(this.nextSong(this.songs))
            else if (this.mode === "shuffle")
                this.playPauseSong(this.nextSong(this.shuffled))
        }
        prev() {
            $("#player audio").pause()
            this.playPauseSong(this.nextSong(
                (this.mode === "shuffle") ? this.shuffled : this.songs, -1))
        }
        next() {
            $("#player audio").pause()
            this.playPauseSong(this.nextSong(
                (this.mode === "shuffle") ? this.shuffled : this.songs))
        }
        seekBackward(diff=null) {
            diff = diff ?? 10
            $("#player audio").currentTime -= diff
        }
        seekForward(diff=null) {
            diff = diff ?? 10
            $("#player audio").currentTime = Math.min(
                $("#player audio").currentTime + diff,
                $("#player audio").duration - 0.1)
        }
        volumeUp(diff=null) {
            diff = diff ?? 0.1
            $("#player audio").volume = Math.min(1, $("#player audio").volume + diff)
        }
        volumeDown(diff=null) {
            diff = diff ?? 0.1
            $("#player audio").volume = Math.max(0, $("#player audio").volume - diff)
        }

        onMediaAction(args) {
            const action = args.action
            if (action === "play")
                $("#player audio").play()
            else if (action === "pause")
                $("#player audio").pause()
            else if (action === "stop") {
                $("#player audio").pause()
                $("#player audio").currentTime = 0
            }

            else if (action === "previoustrack")
                this.prev()
            else if (action === "nexttrack")
                this.next()

            else if (action === "seekbackward")
                this.seekBackward(args.seekOffset)
            else if (action === "seekforward")
                this.seekForward(args.seekOffset)
            else if (action === "seekto")
                $("#player audio").currentTime = args.seekTime
        }
        onKeyDown(event) {
            if (event.target.nodeName !== "BODY")
                return
            if (!$("#player").classList.contains("player-open"))
                return

            const code = event.code
            let handled = true
            if (["Space", "KeyC"].includes(code))
                this.playPause()
            else if (["ArrowLeft"].includes(code))
                this.seekBackward()
            else if (["ArrowRight"].includes(code))
                this.seekForward()
            else if (["ArrowUp"].includes(code))
                this.volumeUp()
            else if (["ArrowDown"].includes(code))
                this.volumeDown()
            else if (["KeyZ", "KeyP"].includes(code))
                this.prev()
            else if (["KeyV", "KeyN"].includes(code))
                this.next()
            else if (["KeyX"].includes(code))
                this.playReplay()
            else if (["KeyR"].includes(code))
                this.switchMode(this.mode === "shuffle" ? "all" : "shuffle")
            else if (["KeyL"].includes(code))
                this.switchMode(this.mode === "repeat" ? "one" : "repeat")
            else
                handled = false

            if (handled) {
                event.preventDefault()
                event.stopPropagation()
            }
        }
    }

    class KtvApp {
        constructor(localStorageKey="kirksud_ktv_kkbox") {
            this.localStorageKey = localStorageKey
            
            $on("click", "#back", e => history.back())
            $on("click", "#singerButton", e => this.navigate({singer: ""}))
            $on("change", "#company", e => this.onCompany())
            $on("change", "#search", e => this.onChange())
            $on("change", "#favCheckbox", e => this.onChange())
            $on("change", "#selectStart", e => this.onChange())
            $on("change", "#selectEnd", e => this.onChange())
            $on("popstate", window, e => this.onPopState())

            const synkServer = "https://kirk.alwaysdata.net"
            // const synkServer = "https://kirksud.pythonanywhere.com"
            this.synk = new Synk(
                synkServer, "1MB", this.localStorageKey,
                "ktv_kkbox", () => this.show())

            this.modal = new Modal(() => this.saveState(true))
            this.player = new PlayerWidget(this)
            this.singer = null
            this.initCompany()
            this.initYear()
            this.show()
            this.synk.run()
        }

        load() {
            const data = JSON.parse(localStorage.getItem(this.localStorageKey) ?? "null") ?? {
                version: "0.1",
                company: "",
                favSongs: [],
                favSingers: [],
                ytapToken: null,
            }
            return data
        }
        save(data) {
            localStorage.setItem(this.localStorageKey, JSON.stringify(data))
            this.synk.run()
        }

        onCompany() {
            const data = this.load()
            data.company = $("#company").value
            this.save(data)
            this.show()
        }
        currentState() {
            return {
                singer: this.singer,
                search: $("#search").value,
                fav: $("#favCheckbox").checked,
                start: $("#selectStart").value,
                end: $("#selectEnd").value,
                scroll: $("#items").scrollTop,
            }
        }
        saveState(modalClose=false) {
            const s = this.currentState()
            if (modalClose)
                s.modalClose = true
            history.replaceState(s, "")
        }
        onChange() {
            this.show()
            this.saveState()
        }
        navigate(state) {
            this.saveState()

            this.singer = state.singer
            $("#search").value = state.search ?? ""
            $("#favCheckbox").checked = state.fav ?? false
            $("#selectStart").value = state.start ?? ""
            $("#selectEnd").value = state.end ?? ""

            history.pushState({}, "")
            this.show()
            this.saveState()
        }
        onPopState() {
            const s = history.state
            if (s && s.modalClose) {
                delete s.modalClose
                return
            }
            if (!(s && "singer" in s))
                return
            this.singer = s.singer
            $("#search").value = s.search
            $("#favCheckbox").checked = s.fav
            $("#selectStart").value = s.start
            $("#selectEnd").value = s.end

            this.show()
            $("#items").scrollTop = s.scroll
        }

        filterSinger() {
            const state = this.currentState()
            let singers = ktvData.singers
            if (state.fav) {
                const favSingers = this.load().favSingers
                singers = singers.filter(singer => KtvData.isFavSinger(singer, favSingers))
            }

            if (state.start !== "" || state.end !== "") {
                state.start = (state.start === "") ? -Infinity : Number(state.start)
                state.end = (state.end === "") ? Infinity : Number(state.end)

                singers = singers.filter(singer => {
                    const singerYear = ("first" in singer) ?
                        new Date(singer.first).getFullYear() :
                        (singer.album ?? singer.guessAlbum ?? 0)
                    return singerYear >= state.start && singerYear <= state.end
                })
            }
            singers = KtvData.filterSinger(singers, state.search)
            return singers
        }
        filterSong() {
            const state = this.currentState()
            let songs = ktvData.songs
            if (state.fav) {
                const favSongsTable = KtvData.favSongsTable(this.load().favSongs)
                songs = songs.filter(song => KtvData.isFavSong(song, favSongsTable))
            }

            if (state.start !== "" || state.end !== "") {
                state.start = (state.start === "") ? -Infinity : Number(state.start)
                state.end = (state.end === "") ? Infinity : Number(state.end)

                songs = songs.filter(song => {
                    const songDate = ("rankings" in song) ?
                        song.rankings.first :
                        (song.releaseDate ?? song.albumDate)
                    const songYear = songDate ? new Date(songDate).getFullYear() : 0
                    return songYear >= state.start && songYear <= state.end
                })
            }

            if (this.singer)
                songs = KtvData.filterSong(songs, this.singer, ["singer"])
            songs = KtvData.filterSong(
                songs, state.search, ["name", "singer", "albumName", "code"], true)
            return songs
        }

        initCompany() {
            $("#company").innerHTML = `<option value="">未選擇</option>`
            for (const company of KtvData.allCompanies(ktvData.songs))
                $("#company").insertAdjacentHTML("beforeend", `
                    <option value="${company}">${company}</option>`)
            $("#company").value = this.load().company
        }
        initYear() {
            for (let y=new Date().getFullYear(); y>=1960; y--) {
                const h = `<option value="${y}">${y}</option>`
                $("#selectStart").insertAdjacentHTML("beforeend", h)
                $("#selectEnd").insertAdjacentHTML("beforeend", h)
            }
        }

        show() {
            $("#singerButton").classList.remove("d-flex")
            if (this.singer === null) {
                $("#singerButton").classList.add("d-flex")
                this.showSongs()
            }
            else if (this.singer === "")
                this.showSingers()
            else
                this.showSingerSongs()
        }
        showSongs() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (search === "") ? "所有歌曲" : `歌曲「${search}」`
            this.appendSongs(this.filterSong())
        }
        showSingers() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (search === "") ? "所有歌手" : `歌手「${search}」`
            this.appendSingers(this.filterSinger())
        }
        showSingerSongs() {
            const search = $("#search").value
            $("#items").innerHTML = ""
            $("#title").innerText = (
                search === "") ? `「${this.singer}」的歌曲` : `「${this.singer}」的「${search}」`
            this.appendSongs(this.filterSong())
        }

        simpleItem(icon, text, click) {
            const element = $html(`
                <div>
                    <div class="d-flex">
                        <button class="icon-button">
                            <i class="material-symbols-outlined">${icon}</i>
                        </button>
                        <p class="font-large">${text}</p>
                    </div>
                </div>`)
            $on("click", element, click)
            return element
        }
        clearSearch() {
            $("#search").value = ""
            $("#favCheckbox").checked = false
            $("#selectStart").value = ""
            $("#selectEnd").value = ""
            this.show()
        }

        appendSongs(songs) {
            const maxItems = 500
            const selectedCompany = $("#company").value
            const favSongsTable = KtvData.favSongsTable(this.load().favSongs)
            $("#title").innerText = `(${songs.length}首) ` + $("#title").innerText

            for (const song of songs.slice(0, maxItems)) {
                const name = ("name" in song) ? KtvData.toArray(song.name)[0] : ""
                const singer = ("singer" in song) ? KtvData.toArray(song.singer)[0] : ""
                const lang = ("lang" in song) ? KtvData.toArray(song.lang)[0] : ""

                let code = ""
                if ("code" in song && selectedCompany === "")
                    code = (song.code.length === 1) ?
                        song.code[0][1] : `${song.code.length}個`
                else if ("code" in song && selectedCompany !== "") {
                    code = song.code
                        .filter(([company, code]) => company === selectedCompany)
                        .map(([company, code]) => code)
                    code = (code.length <= 2) ? code.join(" / ") : `${code[0]} / 共${code.length}個`
                }
                let company = ""
                if ("code" in song && code !== "")
                    company = (selectedCompany !== "") ? selectedCompany : (
                        (song.code.length === 1) ? song.code[0][0] : `${song.code.length}個`)
                if (code === "")
                    code = "無"
                const isFavSong = KtvData.isFavSong(song, favSongsTable)
                const hasYoutube = ("youtubeID" in song)

                let html = `
                    <div class="d-flex font-large">
                        <button class="fav-btn icon-button ${isFavSong ? "font-fill" : ""}">
                            <i class="material-symbols-outlined">star</i>
                        </button>
                        <p class="flex-1">${escapeHtml(name)}</p>
                        <p>${code}</p>
                    </div>
                    <div class="d-flex">
                        <button class="play-btn icon-button font-fill ${hasYoutube ? "" : "d-none"}">
                            <i class="material-symbols-outlined">play_arrow</i>
                        </button>
                        <button class="search-btn icon-button ${hasYoutube ? "d-none" : ""}">
                            <i class="material-symbols-outlined">search</i>
                        </button>
                        <p class="flex-1">${escapeHtml(singer)}</p>
                        <p>${lang} / ${company}</p>
                    </div>`

                if ("rankings" in song) {
                    const r = song.rankings
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">${r.score} 分 / ${r.weeks} 次</p>
                            <p>#${r.top} / ${r.first} ~ ${r.last}</p>
                        </div>`
                }
                else if ("releaseDate" in song) {
                    const d = KtvData.toArray(song.releaseDate)[0]
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">發行 ${d}</p>
                        </div>`
                }
                else if ("albumDate" in song) {
                    const d = KtvData.toArray(song.albumDate)[0]
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">專輯發行 ${d}</p>
                        </div>`
                }

                const element = $html(`<div>${html}</div>`)
                $on("click", $("button.fav-btn", element), e => this.toggleFavSong(e, song))
                $on("click", $("button.play-btn", element), event => {
                    event.stopPropagation()
                    this.player.playPauseSong(song, true)
                })
                $on("click", $("button.search-btn", element), event => {
                    event.stopPropagation()
                    const ytSearchURL = new URL("https://www.youtube.com/results")
                    ytSearchURL.searchParams.set("search_query", name + " " + singer)
                    window.open(ytSearchURL.href)
                })
                $on("click", element, e => this.showDetail(song))
                $("#items").appendChild(element)
            }
            if (songs.length === 0)
                $("#items").appendChild(
                    this.simpleItem("close", "無結果", e => this.clearSearch()))
            this.player.updatePlayIcons()
        }

        appendSingers(singers) {
            const maxItems = 500
            const favSingers = this.load().favSingers
            $("#title").innerText = `(${singers.length}位) ` + $("#title").innerText

            for (const singer of singers.slice(0, maxItems)) {
                const isFavSinger = KtvData.isFavSinger(singer, favSingers)
                let html = `
                    <div class="d-flex">
                        <button class="icon-button ${isFavSinger ? "font-fill" : ""}">
                            <i class="material-symbols-outlined">star</i>
                        </button>
                        <p class="flex-1 font-large">${escapeHtml(singer.name)}</p>
                        <p>${singer.count} 首</p>
                    </div>`
                if ("score" in singer)
                    html += `
                        <div class="d-flex font-small">
                            <p class="flex-1">${singer.score} 分 / ${singer.weeks} 次</p>
                            <p>#${singer.top} / ${singer.first} ~ ${singer.last}</p>
                        </div>`
                else if (["start", "end", "birth", "album"].some(i => i in singer)) {
                    html += `<div class="d-flex font-small">`
                    html += `<p class="flex-1">`
                    if ("birth" in singer)
                        html += `${singer.birth} 生`
                    else if (("start" in singer) || ("end" in singer))
                        html += `${singer.start ?? ""} ~ ${singer.end ?? ""}`
                    html += "</p>"
                    if ("album" in singer)
                        html += `<p>首發 ${singer.album}</p>`
                    html += "</div>"
                }
                const element = $html(`<div>${html}</div>`)
                $on("click", $("button", element), e => this.toggleFavSinger(e, singer))
                $on("click", element, e => this.navigate({singer: singer.name}))
                $("#items").appendChild(element)
            }
            if (singers.length === 0)
                $("#items").appendChild(
                    this.simpleItem("close", "無結果", e => this.clearSearch()))
        }

        toggleFavSong(event, song) {
            event.stopPropagation()
            if (!("name" in song) || !("singer" in song))
                return
            const data = this.load()
            let isFav
            [isFav, data.favSongs] = KtvData.toggleFavSong(song, data.favSongs)
            if (isFav)
                event.currentTarget.classList.add("font-fill")
            else
                event.currentTarget.classList.remove("font-fill")
            this.save(data)
        }
        toggleFavSinger(event, singer) {
            event.stopPropagation()
            const data = this.load()
            let isFav
            [isFav, data.favSingers] = KtvData.toggleFavSinger(singer, data.favSingers)
            if (isFav)
                event.currentTarget.classList.add("font-fill")
            else
                event.currentTarget.classList.remove("font-fill")
            this.save(data)
        }

        showDetail(song) {
            function addInfoBlock(key, title, formatter=null) {
                if (!(key in song))
                    return
                const values = KtvData.toArray(song[key])
                if (key === "code")
                    values.sort()
                if ($("#detail").innerHTML !== "")
                    $("#detail").insertAdjacentHTML("beforeend", "<hr>")
                $("#detail").insertAdjacentHTML("beforeend",
                    `<p class="font-bold">${title}</p>`)
                for (let value of values) {
                    if (formatter === null) {
                        if ((typeof value) !== "string")
                            value = `${value}`
                        $("#detail").insertAdjacentHTML("beforeend",
                            `<p>${escapeHtml(value)}</p>`)
                    }
                    else
                        $("#detail").insertAdjacentHTML("beforeend",
                            formatter(value))
                }
            }

            const fields = {
                "name": "曲名",
                // "subname": "副名稱",
                "singer": "歌手",
                "albumName": "專輯",
                "releaseDate": "發行日",
                "albumDate": "專輯發行日",
                "lang": "語言",
                "sex": "性別",
                // "isVariousArtists": "多作者",
                "code": "KTV 代碼",
                // "songDate": "KTV 日期"
            }
            const rankingFields = {
                "score": "總分",
                "top": "最高排名",
                "weeks": "上榜週數",
                "first": "初次上榜",
                "last": "最後上榜",
            }
            const linkFields = {
                "youtubeID": ["YouTube", "https://youtu.be/"],
                "trackID": ["KKBOX 歌曲", "https://www.kkbox.com/tw/tc/song/"],
                "artistID": ["KKBOX 歌手", "https://www.kkbox.com/tw/tc/artist/"],
                "albumID": ["KKBOX 專輯", "https://www.kkbox.com/tw/tc/album/"]
            }

            $("#detail").innerHTML = ""
            for (const [key, title] of Object.entries(fields)) {
                if (key === "code")
                    addInfoBlock(key, title, ([company, code]) => `<p>${company}: ${code}</p>`)
                else
                    addInfoBlock(key, title)
            }
            if ("rankings" in song) {
                $("#detail").insertAdjacentHTML("beforeend", "<hr>")
                $("#detail").insertAdjacentHTML("beforeend",
                    `<p class="font-bold">KKBOX 華語單曲週榜</p>`)
                for (const [key, title] of Object.entries(rankingFields))
                    $("#detail").insertAdjacentHTML("beforeend",
                        `<p>${title}: ${song.rankings[key]}</p>`)
            }
            for (const [key, [title, linkPrefix]] of Object.entries(linkFields))
                addInfoBlock(key, title,
                    value => `<p><a target="_blank" href="${linkPrefix}${value}">${value}</a></p>`)
            this.modal.openModal("#detailModal")
            $("#detail").scrollTop = 0
        }
    }
    $on("load", window, e => new KtvApp())

})()

    </script>
</body>
</html>
